# JAVASCRIPT - EXECUTION CONTEXT

## 1. 실행 컨텍스트
실행 컨택스트 : 실행 가능한 코드블럭이 실행되는 환경
- 실행 가능한 코드
  - GLOBAL CODE : 전역 영역에 존재하는 코드
  - EVAL CODE : EVAL 함수로 실행되는 코드
  - FUNCTION CODE : 함수내에 존재하는 코드

> 일반적으로 실행 가능한 코드는 전역코드와 함수 내 코드이다.

`스크립트 엔진은 코드를 실행하기 위해 실행에 필요한 여러가지 정보를 알고 있어야 하는데 이들 실행에 필요한 여러가지 정보를 관리하기 위한 객체 : 실행 컨텍스트`

- 실행에 필요한 여러가지 정보
    - 변수 
        - 함수내부에서만 접근할 수 있는 지역변수
        - 메소드에서 THIS 를 통해 접근할 수 있는 객체의 프로퍼티
          - 물론 전역변수도 있지만 이것은 말 그대로 전역으로 존재하며 특정함수나 객체에 속하는 것이 아니므로 논의에서 제외한다.
    - 매개변수 
    - 함수선언
    - 변수의 유효범위
    - THIS

```javascript
var x = 'xxx';

function foo () {
  var y = 'yyy';

  function bar () {
    var z = 'zzz';
    console.log(x + y + z);
  }
  bar();
}
foo();
```

> 실행 컨텍스트 스택 : 논리적 스택 구조를 가진다.

- 컨트롤이 실행 가능한 코드로 이동하면 논리적 스택구조를 가지는 새로운 실행 컨텍스트 스택이 생성된다. 스택은 LIFO(후입선출)의 구조를 가지는 나열구조이다.
- GLOBAL CODE로 컨트롤이 들어가면 전역 실행 컨텍스트가 실행 컨텍스트 스택에 쌓인다. 전역 실행 컨텍스트는 앱이 종료될 때까지 유지된다.
- 함수를 호출하면 해당 함수의 실행 컨텍스트가 생성되며 직전에 실행된 코드블럭의 실행 컨텍스트 위에 쌓인다.
- 함수 실행이 끝나면 해당 함수의 실행 컨텍스트를 파기하고 직전의 실행 컨텍스트에 컨트롤을 반환한다.

## 2. 실행 컨텍스트 객체의 프로퍼티
실행컨텍스트 : 객체

- 3가지 프로퍼티
  - VARIABLE OBJECT 
  - SCOPE CHAIN
  - THISVALUE

### 1. VARIABLE OBJECT(VO/변수객체)
VARIABLE OBJECT : 컨텍스트가 생성되면 엔진은 실행에 필요한 여러정보들을 담을 객체를 생성한다.

> 코드가 실행될 때 엔진에 의해 참조되며 코드에서는 접근할 수없다.

*정보
- 변수
- 매개변수와 인수
- 함수 선언(함수표현식은 제외)

전역 컨텍스트의 경우 
> VO는 유일하고 최상위에 위치. 모든 전역 변수,함수등을 포함하는 전역객체를 가리킨다. 
`전역객체는 전역에 선언된 전역변수와 전역함수를 프로퍼티로 소유한다.`

함수 컨텍스트의 경우
> VO는 ACTIVATION OBJECT(AO/활성객체)를 가리키며 매개변수와 인수들의 정보를 배열의 형태로 담고있는 객체인 arguments object가 추가된다.

### 2. Scope Chain (SC)
일종의 리스트로 중첩된 함수의 스코프의 레퍼런스를 차례로 저장하고 있는 개념.
> 즉 scope chain은 현재 실행 컨텍스트의 ao를 선두로 순차적인 상위컨텍스트의 ao를 가리킨다.
`마지막 리스트는 전역 객체를 가리킨다.`

---

### 3. this value
this 프로퍼티에는 this 값이 할당된다.
>this 에 할당되는 값은 함수 호출 패턴에 의해 결정된다.

## 3. 실행 컨텍스트의 생성과정

### 1. global code에 진입
컨트롤이 실행컨텍스트에 들어가기 이전에 유일한 전역 객체가 생성된다. 

전역객체 내용 : this, scope chain, variable object 순으로 스택된다.

> 실행 컨텍스트를 바탕으로 다음의 처리가 실행된다.
- scope chain의 생성과 초기화
- variable instantiation 실행
- this value 결정

### 2. scope chain의 생성과 초기화
새로운 실행 컨텍스트에 들어가게 되면 scope chain 생성과 초기화가 실행된다.

> global code로 컨트롤이 이동하면 scope chain 은 전역 객체의 레퍼런스를 포함하는 리스트가 된다.

### 3. variable instantiation (변수 객체화) 실행
variable object 에 프로퍼티와 값을 추가하는 것

> global code의 경우, variable object는 global object를 가리킨다.

` 변수객체화는 다음의 순서로 VO에 프로퍼티와 값을 설정한다`
- FUNCTION CODEDLS 경우
    - 매개변수가 VO의 프로퍼티로, 인수가 값으로 설정된다.
- 대상 코드 내의 함수선언(함수표현식 제외)을 대상으로 함수명이 VO의 프로퍼티로 생성된 FUNCTION OBJECT가 값으로 SET된다.(함수 호이스팅)
- 대상 코드 내의 변수선언을 대상으로 변수명이 VARIABLE OBJECT 의 프로퍼티로 UNDEFINED가 값으로 SET 된다.(변수 호이스팅)

#### 1. 함수 선언 처리
함수 선언은 변수 객체화 실행 순서와 같이 선언된 함수명이 VO 의 프로퍼티로 생성된 FUNCTION OBJECT가 값으로 바인딩된다. (GLOBAL CODE인 경우 GLOBAL OBJECT)

> 생성된 FUNCTION OBJECT는 [[SCOPE]]프로퍼티를 가지게 된다.

`[[SCOPE]] : 값으로 현재 실행 컨텍스트의 SCOPE CHAIN이 참조하고 있는 객체와 같은 객체를 참조하는 리스트가 바인딩된다.`

> 함수 호이스팅 : 함수선언식 이전에 함수를 호출하는 것 

> 스코프 체인이 가리키는 변수 객체에 이미 함수가 등록되어 있기 때문

#### 2. 변수 선언 처리
변수 선언은 변수 객체화 실행 순서와 같이 선언된 변수명이 VO의 프로퍼티로 UNDEFINED가 값으로 설정된다.

- 선언단계 
  - 변수 객체에 변수를 등록한다. 스코프가 참조할 수 있는 대상이 된다.
- 초기화 단계
  - 변수 객체에 등록된 변수들을 메모리에 할당한다. UNDEFINED로 초기화
- 할당 단계
  - UNDEFINED로 초기화 된 변수에 실제값을 할당

`VAR 키워드로 선언된 변수는 선언 단계와 초기화 단계가 한번에 이루어진다.`

> 변수 호이스팅 : 변수 선언문 이전에 변수에 접근하여도 VO에 변수가 존재하기 때문에 에러가 발생하지 않는다.

#### 3. THIS VALUE 결정
변수선언 처리가 끝나고 결정된다. 

>THIS 에 할당되는 값은 함수 호출 패턴에 의해 결정

GLOBAL CODE의 경우, VO, SC, THIS 는 언제나 전역 객체

### 2. GLOBAL CODE의 실행

#### 1. 변수 값의 할당
변수에 값을 할당할 때, 현재 실행 컨텍스트의 SCOPE CHAIN이 참조하는 VO를 선두(0)부터 검색해 변수명에 해당하는 프로퍼티가 발견되면 값을 할당한다.

#### 2. 함수의 실행
함수가 실행되기 시작하면 새로운 함수 실행 컨텍스트가 생성된다.
> 전역 컨텍스트와 같이 순차적으로 실행 

- SCOPE CHAIN의 생성과 초기화
- 변수 객체화 실행 
- THIS VALUE 결정

> 다른 점은 FUNCTION CODE의 룰이 적용된다.

---

##### 1. (함수) SCOPE CHAIN의 생성과 초기화 
ACTIVATION OBJECT에 대한 레퍼런스를 SCOPE 체인의 선두에 바인딩하는 것으로 시작

ACTIVATION OBJECT : 인수 프로퍼티의 초기화를 실행한 후 변수 객체화가 실행된다. 함수의 실행으로 만들어진다.
> AO는 스펙상의 개념, 프로그램이 직접 접근할 수없다. 
`AO의 프로퍼티로의 접근은 가능`

##### 2. 변수 객체화 실행
AO를 VO로서 변수 객체화가 실행된다. 

> 함수 객체를 VO(AO)에 바인딩한다.

##### 3. THIS VALUE 결정
THIS에 할당되는 값은 함수 호출 패턴에 의해 결정된다.

> 내부함수의 경우, THIS의 밸류는 전역객체

---

#### 3. FUNCTION CODE의 실행
구문 실행

##### 1. 변수 값의 할당

##### 2. 함수의 실행
함수가 실행되기 시작하면 새로운 실행 컨텍스트가 생성된다.

> 이전 함수의 실행과정과 동일하게 순차적으로 실행된다.

---

### 완성
완성되면 다음 예시처럼 검색한다.
- x : AO-2에서 x 검색 실패 → AO-1에서 x 검색 실패 → GO에서 x 검색 성공 (값은 ‘xxx’)
- y : AO-2에서 y 검색 실패 → AO-1에서 y 검색 성공 (값은 ‘yyy’)
- z : AO-2에서 z 검색 성공 (값은 ‘zzz’)